<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Plate Recognition Viewer - Potassium Factory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .main-container {
            padding: 2rem 0;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .case-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }

        .case-card:hover {
            transform: translateY(-2px);
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 1rem;
        }

        .processed-image {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .processed-image:hover {
            transform: scale(1.05);
        }

        .processed-image img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .plate-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 8px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .badge-custom {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .loading-spinner {
            display: none;
        }

        .loading-spinner.show {
            display: block;
        }

        .violation-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
        }

        .confidence-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48ca5c);
            transition: width 0.3s ease;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="#">
                <i class="fas fa-camera me-2"></i>
                AI Plate Recognition
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Refresh
                </button>
                <button class="btn btn-primary btn-sm" onclick="showSyncStats()">
                    <i class="fas fa-chart-bar me-1"></i>
                    Stats
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container main-container">
        <!-- Statistics Row -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card card h-100 text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-camera fa-2x text-primary mb-2"></i>
                        <h5 class="card-title mb-1">Total Cases</h5>
                        <h3 class="text-primary mb-0" id="totalCases">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card card h-100 text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-eye fa-2x text-success mb-2"></i>
                        <h5 class="card-title mb-1">Plates Detected</h5>
                        <h3 class="text-success mb-0" id="totalPlates">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card card h-100 text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-database fa-2x text-warning mb-2"></i>
                        <h5 class="card-title mb-1">Database Fines</h5>
                        <h3 class="text-warning mb-0" id="totalFines">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card card h-100 text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-sync fa-2x text-info mb-2"></i>
                        <h5 class="card-title mb-1">Sync Rate</h5>
                        <h3 class="text-info mb-0" id="syncRate">0%</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="text-center loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading AI processed cases...</p>
        </div>

        <!-- Cases Container -->
        <div id="casesContainer">
            <!-- Cases will be loaded here -->
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Image Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="img-fluid rounded" alt="Processed Image">
                    <div class="mt-3" id="modalDetails">
                        <!-- Image details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Stats Modal -->
    <div class="modal fade" id="syncStatsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">AI Sync Statistics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="syncStatsContent">
                    <!-- Sync stats will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:3001/api';
        const AI_API_BASE = 'http://localhost:3004/api';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAiCases();
            loadSyncStats();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadAiCases();
                loadSyncStats();
            }, 30000);
        });

        // Load AI processed cases
        async function loadAiCases() {
            try {
                showLoading(true);
                
                const response = await fetch(`${AI_API_BASE}/ai-cases`);
                const data = await response.json();
                
                if (data.success) {
                    displayCases(data.cases);
                    updateStats(data.cases);
                } else {
                    console.error('Failed to load AI cases:', data.error);
                    showError('Failed to load AI cases');
                }
            } catch (error) {
                console.error('Error loading AI cases:', error);
                showError('Connection error. Please check if AI Results API is running on port 3004.');
            } finally {
                showLoading(false);
            }
        }

        // Display cases in the UI
        function displayCases(cases) {
            const container = document.getElementById('casesContainer');
            
            if (cases.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No AI processed cases found</h4>
                        <p class="text-muted">AI processed violation cases will appear here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = cases.map(caseData => `
                <div class="case-card card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-video me-2"></i>
                                ${caseData.camera} - ${caseData.caseName}
                            </h6>
                            <small class="text-muted">${formatDate(caseData.processingTimestamp)}</small>
                        </div>
                        <div class="d-flex gap-2">
                            ${caseData.originalData?.decision === 'violation' ? 
                                `<span class="badge violation-badge">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    VIOLATION ${caseData.originalData.speed}/${caseData.originalData.limit} km/h
                                </span>` : 
                                '<span class="badge bg-success">COMPLIANT</span>'
                            }
                            <span class="badge bg-info">
                                <i class="fas fa-images me-1"></i>
                                ${caseData.imagesProcessed} images
                            </span>
                            <span class="badge bg-primary">
                                <i class="fas fa-license-plate me-1"></i>
                                ${caseData.platesDetected} plates
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${caseData.aiResults.detected_plates?.length > 0 ? `
                            <div class="mb-3">
                                <h6><i class="fas fa-list me-2"></i>Detected Plates:</h6>
                                ${caseData.aiResults.detected_plates.map(plate => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                        <span class="fw-bold font-monospace">${plate.plate_text}</span>
                                        <div>
                                            <span class="badge badge-custom bg-secondary me-2">${plate.detection_method}</span>
                                            <span class="badge badge-custom bg-success">${Math.round(plate.confidence * 100)}%</span>
                                        </div>
                                    </div>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${plate.confidence * 100}%"></div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-muted">No plates detected</p>'}
                        
                        <div class="image-gallery">
                            ${caseData.aiResults.processed_images?.map(img => `
                                <div class="processed-image" onclick="showImageModal('${caseData.casePath}/ai/processed_${img.filename}', '${img.filename}', ${JSON.stringify(img.alpr_result).replace(/"/g, '&quot;')})">
                                    <img src="${caseData.casePath}/ai/processed_${img.filename}" 
                                         alt="Processed ${img.filename}"
                                         onerror="this.src='${caseData.casePath}/${img.filename}'">
                                    ${img.alpr_result?.plates_detected?.length > 0 ? `
                                        <div class="plate-overlay">
                                            <i class="fas fa-license-plate me-1"></i>
                                            ${img.alpr_result.plates_detected[0].plate_text}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('') || '<p class="text-muted">No processed images available</p>'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update statistics
        function updateStats(cases) {
            const totalCases = cases.length;
            const totalPlates = cases.reduce((sum, c) => sum + (c.platesDetected || 0), 0);
            
            document.getElementById('totalCases').textContent = totalCases;
            document.getElementById('totalPlates').textContent = totalPlates;
        }

        // Load sync statistics
        async function loadSyncStats() {
            try {
                const response = await fetch(`${API_BASE}/ai-sync/stats`);
                const data = await response.json();
                
                if (data.success && data.stats) {
                    document.getElementById('totalFines').textContent = data.stats.totalFines || 0;
                    document.getElementById('syncRate').textContent = `${data.stats.syncRate || 0}%`;
                }
            } catch (error) {
                console.error('Error loading sync stats:', error);
            }
        }

        // Show image modal
        function showImageModal(imageSrc, filename, alprResult) {
            document.getElementById('modalTitle').textContent = `Processed Image: ${filename}`;
            document.getElementById('modalImage').src = imageSrc;
            
            const details = document.getElementById('modalDetails');
            if (alprResult && alprResult.plates_detected && alprResult.plates_detected.length > 0) {
                const plate = alprResult.plates_detected[0];
                details.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Plate Number:</strong><br>
                            <span class="font-monospace fs-5">${plate.plate_text}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Confidence:</strong><br>
                            <span class="fs-5">${Math.round(plate.confidence * 100)}%</span>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <strong>Detection Method:</strong><br>
                            ${plate.detection_method}
                        </div>
                        <div class="col-md-6">
                            <strong>Processing Time:</strong><br>
                            ${formatDate(alprResult.timestamp)}
                        </div>
                    </div>
                `;
            } else {
                details.innerHTML = '<p class="text-muted">No plate detection data available</p>';
            }
            
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        // Show sync stats modal
        async function showSyncStats() {
            try {
                const response = await fetch(`${API_BASE}/ai-sync/stats`);
                const data = await response.json();
                
                if (data.success && data.stats) {
                    const stats = data.stats;
                    document.getElementById('syncStatsContent').innerHTML = `
                        <div class="row">
                            <div class="col-6 mb-3">
                                <strong>Service Status:</strong><br>
                                <span class="badge ${stats.isRunning ? 'bg-success' : 'bg-danger'}">
                                    ${stats.isRunning ? 'Running' : 'Stopped'}
                                </span>
                            </div>
                            <div class="col-6 mb-3">
                                <strong>Sync Rate:</strong><br>
                                ${stats.syncRate}%
                            </div>
                            <div class="col-6 mb-3">
                                <strong>Total AI Cases:</strong><br>
                                ${stats.totalAiCases}
                            </div>
                            <div class="col-6 mb-3">
                                <strong>Processed Cases:</strong><br>
                                ${stats.processedCases}
                            </div>
                            <div class="col-6 mb-3">
                                <strong>Total Fines:</strong><br>
                                ${stats.totalFines}
                            </div>
                            <div class="col-6 mb-3">
                                <strong>Pending Fines:</strong><br>
                                ${stats.pendingFines}
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary btn-sm me-2" onclick="triggerManualSync()">
                                <i class="fas fa-sync me-1"></i>
                                Manual Sync
                            </button>
                        </div>
                    `;
                }
                
                new bootstrap.Modal(document.getElementById('syncStatsModal')).show();
            } catch (error) {
                console.error('Error loading sync stats:', error);
                showError('Failed to load sync statistics');
            }
        }

        // Trigger manual sync
        async function triggerManualSync() {
            try {
                const response = await fetch(`${API_BASE}/ai-sync/sync`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('Manual synchronization completed successfully!');
                    loadSyncStats();
                    loadAiCases();
                } else {
                    alert('Sync failed: ' + data.error);
                }
            } catch (error) {
                console.error('Error triggering sync:', error);
                alert('Failed to trigger manual sync');
            }
        }

        // Refresh data
        function refreshData() {
            loadAiCases();
            loadSyncStats();
        }

        // Show/hide loading spinner
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.add('show');
            } else {
                spinner.classList.remove('show');
            }
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('casesContainer');
            container.innerHTML = `
                <div class="alert alert-danger text-center" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }
    </script>
</body>
</html>
